<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.changing.erpsystembackend.mapper.PurchasingOrderMapper">
    <!-- Insert -->
    <insert id="insertPurchasingOrder" parameterType="com.changing.erpsystembackend.entity.PurchasingOrder">
        INSERT INTO "PurchasingOrder" (PURCHASING_EMPLOYEE_ID, COMPANY_ID, QUANTITY, CONTRACT, APPLY_DATE, DEPARTURE, STATUS, MATERIAL_NAME, DESCRIPTION)
        VALUES (#{purchasingEmployeeId}, #{companyId}, #{quantity}, #{contract}, #{applyDate}, #{departure}, #{status}, #{materialName}, #{description})
    </insert>

    <!-- Update -->
    <update id="checkPurchasingOrder" parameterType="com.changing.erpsystembackend.dto.purchasing.CheckPurchasingOrderRequestDTO">
        UPDATE "PurchasingOrder"
        SET STATUS = #{status}
        WHERE ID = #{id}
    </update>

    <!-- Select -->
    <select id="findPurchasingOrder" parameterType="com.changing.erpsystembackend.dto.purchasing.SearchPurchasingOrderRequestDTO" resultMap="PurchasingOrderResultMap">
        SELECT
        po.ID AS ID,
        po.MATERIAL_ID AS MATERIAL_ID,
        po.PURCHASING_EMPLOYEE_ID AS PURCHASING_EMPLOYEE_ID,
        po.COMPANY_ID AS COMPANY_ID,
        po.REPO_EMPLOYEE_ID AS REPO_EMPLOYEE_ID,
        po.QUANTITY AS QUANTITY,
        po.CONTRACT AS CONTRACT,
        po.APPLY_DATE AS APPLY_DATE,
        po.DEPARTURE AS DEPARTURE,
        po.STATUS AS STATUS,
        po.MATERIAL_NAME AS PO_MATERIAL_NAME,
        po.DESCRIPTION AS DESCRIPTION,
        m.NAME AS MATERIAL_NAME,
        m.PRICE AS PRICE,
        m.INVENTORY AS INVENTORY,
        m.REMAINING AS REMAINING,
        e1.PASSWORD AS PURCHASING_EMPLOYEE_PASSWORD,
        e1.DEPARTMENT AS PURCHASING_EMPLOYEE_DEPARTMENT,
        e1.POSITION AS PURCHASING_EMPLOYEE_POSITION,
        e1.START_DATE AS PURCHASING_EMPLOYEE_STARTDATE,
        e1.END_DATE AS PURCHASING_EMPLOYEE_ENDDATE,
        e1.STATUS AS PURCHASING_EMPLOYEE_STATUS,
        e1.RESUME AS PURCHASING_EMPLOYEE_RESUME,
        pi1.NAME AS PURCHASING_EMPLOYEE_NAME,
        pi1.GENDER AS PURCHASING_EMPLOYEE_GENDER,
        pi1.NATIONALITY AS PURCHASING_EMPLOYEE_NATIONALITY,
        pi1.BIRTHDAY AS PURCHASING_EMPLOYEE_BIRTHDAY,
        pi1.BIRTHPLACE AS PURCHASING_EMPLOYEE_BIRTHPLACE,
        pi1.POLITICALSTATUS AS PURCHASING_EMPLOYEE_POLITICALSTATUS,
        pi1.TEL AS PURCHASING_EMPLOYEE_TEL,
        pi1.EMAIL AS PURCHASING_EMPLOYEE_EMAIL,
        e2.PASSWORD AS REPO_EMPLOYEE_PASSWORD,
        e2.DEPARTMENT AS REPO_EMPLOYEE_DEPARTMENT,
        e2.POSITION AS REPO_EMPLOYEE_POSITION,
        e2.START_DATE AS REPO_EMPLOYEE_STARTDATE,
        e2.END_DATE AS REPO_EMPLOYEE_ENDDATE,
        e2.STATUS AS REPO_EMPLOYEE_STATUS,
        e2.RESUME AS REPO_EMPLOYEE_RESUME,
        pi2.NAME AS REPO_EMPLOYEE_NAME,
        pi2.GENDER AS REPO_EMPLOYEE_GENDER,
        pi2.NATIONALITY AS REPO_EMPLOYEE_NATIONALITY,
        pi2.BIRTHDAY AS REPO_EMPLOYEE_BIRTHDAY,
        pi2.BIRTHPLACE AS REPO_EMPLOYEE_BIRTHPLACE,
        pi2.POLITICALSTATUS AS REPO_EMPLOYEE_POLITICALSTATUS,
        pi2.TEL AS REPO_EMPLOYEE_TEL,
        pi2.EMAIL AS REPO_EMPLOYEE_EMAIL,
        c.NAME AS COMPANY_NAME,
        c.TEL AS COMPANY_TEL
        FROM "PurchasingOrder" po
        LEFT JOIN "Material" m ON po.MATERIAL_ID = m.ID
        LEFT JOIN "Employee" e1 ON po.PURCHASING_EMPLOYEE_ID = e1.ID
        LEFT JOIN "Employee" e2 ON po.REPO_EMPLOYEE_ID = e2.ID
        LEFT JOIN "Company" c ON po.COMPANY_ID = c.ID
        LEFT JOIN "Person" pi1 ON e1.PERSON_ID = pi1.ID
        LEFT JOIN "Person" pi2 ON e2.PERSON_ID = pi2.ID
        WHERE 1=1
        <if test="employeeId != null and employeeId != ''">
            AND e1.ID = #{employeeId}
        </if>
        <if test="employeeName != null and employeeName != ''">
            AND pi1.NAME LIKE '%' || #{employeeName} || '%'
        </if>
        <if test="id != null and id != ''">
            AND po.ID = #{id}
        </if>
        <if test="materialName != null and materialName != ''">
            AND po.MATERIAL_NAME LIKE '%' || #{materialName} || '%'
        </if>
        <if test="companyName != null and companyName != ''">
            AND c.NAME LIKE '%' || #{companyName} || '%'
        </if>
        <if test="departure != null and departure != ''">
            AND po.DEPARTURE LIKE '%' || #{departure} || '%'
        </if>
        <if test="status != null and status != ''">
            AND po.STATUS LIKE '%' || #{status} || '%'
        </if>
        <if test="startDate != null">
            AND APPLY_DATE &gt;= #{startDate, jdbcType=DATE, typeHandler=org.apache.ibatis.type.LocalDateTypeHandler}
        </if>
        <if test="endDate != null">
            AND APPLY_DATE &lt;= #{endDate, jdbcType=DATE, typeHandler=org.apache.ibatis.type.LocalDateTypeHandler}
        </if>
    </select>

    <select id="findPurchasingOrderById" resultMap="PurchasingOrderResultMap">
        SELECT
            po.ID AS ID,
            po.MATERIAL_ID AS MATERIAL_ID,
            po.PURCHASING_EMPLOYEE_ID AS PURCHASING_EMPLOYEE_ID,
            po.COMPANY_ID AS COMPANY_ID,
            po.REPO_EMPLOYEE_ID AS REPO_EMPLOYEE_ID,
            po.QUANTITY AS QUANTITY,
            po.CONTRACT AS CONTRACT,
            po.APPLY_DATE AS APPLY_DATE,
            po.DEPARTURE AS DEPARTURE,
            po.STATUS AS STATUS,
            po.MATERIAL_NAME AS PO_MATERIAL_NAME,
            po.DESCRIPTION AS DESCRIPTION,
            m.NAME AS MATERIAL_NAME,
            m.PRICE AS PRICE,
            m.INVENTORY AS INVENTORY,
            m.REMAINING AS REMAINING,
            e1.PASSWORD AS PURCHASING_EMPLOYEE_PASSWORD,
            e1.DEPARTMENT AS PURCHASING_EMPLOYEE_DEPARTMENT,
            e1.POSITION AS PURCHASING_EMPLOYEE_POSITION,
            e1.START_DATE AS PURCHASING_EMPLOYEE_STARTDATE,
            e1.END_DATE AS PURCHASING_EMPLOYEE_ENDDATE,
            e1.STATUS AS PURCHASING_EMPLOYEE_STATUS,
            e1.RESUME AS PURCHASING_EMPLOYEE_RESUME,
            pi1.NAME AS PURCHASING_EMPLOYEE_NAME,
            pi1.GENDER AS PURCHASING_EMPLOYEE_GENDER,
            pi1.NATIONALITY AS PURCHASING_EMPLOYEE_NATIONALITY,
            pi1.BIRTHDAY AS PURCHASING_EMPLOYEE_BIRTHDAY,
            pi1.BIRTHPLACE AS PURCHASING_EMPLOYEE_BIRTHPLACE,
            pi1.POLITICALSTATUS AS PURCHASING_EMPLOYEE_POLITICALSTATUS,
            pi1.TEL AS PURCHASING_EMPLOYEE_TEL,
            pi1.EMAIL AS PURCHASING_EMPLOYEE_EMAIL,
            e2.PASSWORD AS REPO_EMPLOYEE_PASSWORD,
            e2.DEPARTMENT AS REPO_EMPLOYEE_DEPARTMENT,
            e2.POSITION AS REPO_EMPLOYEE_POSITION,
            e2.START_DATE AS REPO_EMPLOYEE_STARTDATE,
            e2.END_DATE AS REPO_EMPLOYEE_ENDDATE,
            e2.STATUS AS REPO_EMPLOYEE_STATUS,
            e2.RESUME AS REPO_EMPLOYEE_RESUME,
            pi2.NAME AS REPO_EMPLOYEE_NAME,
            pi2.GENDER AS REPO_EMPLOYEE_GENDER,
            pi2.NATIONALITY AS REPO_EMPLOYEE_NATIONALITY,
            pi2.BIRTHDAY AS REPO_EMPLOYEE_BIRTHDAY,
            pi2.BIRTHPLACE AS REPO_EMPLOYEE_BIRTHPLACE,
            pi2.POLITICALSTATUS AS REPO_EMPLOYEE_POLITICALSTATUS,
            pi2.TEL AS REPO_EMPLOYEE_TEL,
            pi2.EMAIL AS REPO_EMPLOYEE_EMAIL,
            c.NAME AS COMPANY_NAME,
            c.TEL AS COMPANY_TEL
        FROM "PurchasingOrder" po
                 LEFT JOIN "Material" m ON po.MATERIAL_ID = m.ID
                 LEFT JOIN "Employee" e1 ON po.PURCHASING_EMPLOYEE_ID = e1.ID
                 LEFT JOIN "Employee" e2 ON po.REPO_EMPLOYEE_ID = e2.ID
                 LEFT JOIN "Company" c ON po.COMPANY_ID = c.ID
                 LEFT JOIN "Person" pi1 ON e1.PERSON_ID = pi1.ID
                 LEFT JOIN "Person" pi2 ON e2.PERSON_ID = pi2.ID
        WHERE po.ID = #{id}
    </select>

    <resultMap id="PurchasingOrderResultMap" type="com.changing.erpsystembackend.entity.PurchasingOrder">
        <id property="id" column="ID" />
        <result property="materialId" column="MATERIAL_ID" />
        <result property="purchasingEmployeeId" column="PURCHASING_EMPLOYEE_ID" />
        <result property="companyId" column="COMPANY_ID" />
        <result property="repoEmployeeId" column="REPO_EMPLOYEE_ID" />
        <result property="quantity" column="QUANTITY" />
        <result property="contract" column="CONTRACT" />
        <result property="applyDate" column="APPLY_DATE" />
        <result property="description" column="DESCRIPTION" />
        <result property="status" column="STATUS" />
        <result property="materialName" column="PO_MATERIAL_NAME" />
        <result property="departure" column="DEPARTURE" />
        <association property="material" javaType="com.changing.erpsystembackend.entity.Material">
            <id property="id" column="MATERIAL_ID" />
            <result property="name" column="MATERIAL_NAME" />
            <result property="price" column="PRICE" />
            <result property="inventory" column="INVENTORY" />
            <result property="remaining" column="REMAINING" />
        </association>
        <association property="purchasingEmployee" javaType="com.changing.erpsystembackend.entity.Employee">
            <id property="id" column="PURCHASING_EMPLOYEE_ID" />
            <result property="password" column="PURCHASING_EMPLOYEE_PASSWORD" />
            <result property="department" column="PURCHASING_EMPLOYEE_DEPARTMENT" />
            <result property="position" column="PURCHASING_EMPLOYEE_POSITION" />
            <result property="startDate" column="PURCHASING_EMPLOYEE_STARTDATE" />
            <result property="endDate" column="PURCHASING_EMPLOYEE_ENDDATE" />
            <result property="status" column="PURCHASING_EMPLOYEE_STATUS" />
            <result property="resume" column="PURCHASING_EMPLOYEE_RESUME" />
            <association property="person" javaType="com.changing.erpsystembackend.entity.Person">
                <id property="id" column="PERSON_ID" />
                <result property="name" column="PURCHASING_EMPLOYEE_NAME" />
                <result property="gender" column="PURCHASING_EMPLOYEE_GENDER" />
                <result property="nationality" column="PURCHASING_EMPLOYEE_NATIONALITY" />
                <result property="birthday" column="PURCHASING_EMPLOYEE_BIRTHDAY" />
                <result property="birthplace" column="PURCHASING_EMPLOYEE_BIRTHPLACE" />
                <result property="politicalStatus" column="PURCHASING_EMPLOYEE_POLITICALSTATUS" />
                <result property="tel" column="PURCHASING_EMPLOYEE_TEL" />
                <result property="email" column="PURCHASING_EMPLOYEE_EMAIL" />
            </association>
        </association>
        <association property="company" javaType="com.changing.erpsystembackend.entity.Company">
            <id property="id" column="COMPANY_ID" />
            <result property="name" column="COMPANY_NAME" />
            <result property="tel" column="COMPANY_TEL" />
        </association>
        <association property="repoEmployee" javaType="com.changing.erpsystembackend.entity.Employee">
            <id property="id" column="REPO_EMPLOYEE_ID" />
            <result property="password" column="REPO_EMPLOYEE_PASSWORD" />
            <result property="department" column="REPO_EMPLOYEE_DEPARTMENT" />
            <result property="position" column="REPO_EMPLOYEE_POSITION" />
            <result property="startDate" column="REPO_EMPLOYEE_STARTDATE" />
            <result property="endDate" column="REPO_EMPLOYEE_ENDDATE" />
            <result property="status" column="REPO_EMPLOYEE_STATUS" />
            <result property="resume" column="REPO_EMPLOYEE_RESUME" />
            <association property="person" javaType="com.changing.erpsystembackend.entity.Person">
                <id property="id" column="PERSON_ID" />
                <result property="name" column="REPO_EMPLOYEE_NAME" />
                <result property="gender" column="REPO_EMPLOYEE_GENDER" />
                <result property="nationality" column="REPO_EMPLOYEE_NATIONALITY" />
                <result property="birthday" column="REPO_EMPLOYEE_BIRTHDAY" />
                <result property="birthplace" column="REPO_EMPLOYEE_BIRTHPLACE" />
                <result property="politicalStatus" column="REPO_EMPLOYEE_POLITICALSTATUS" />
                <result property="tel" column="REPO_EMPLOYEE_TEL" />
                <result property="email" column="REPO_EMPLOYEE_EMAIL" />
            </association>
        </association>
    </resultMap>
</mapper>